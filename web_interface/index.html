<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Robot Controller + Camera</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <!-- 外部CSSファイルを読み込み -->
  <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>ORCA丸山ロボット</h1>
    <div id="wrapper">
        <div id="controll-block">
            <h1>何か入る</h1>
            <h2>デザイン調整と他トピックとサービスはこの後追加します</h2>
        </div>

        <div id="camera-block">
            <div class="camera-box">
                <div id="status">状態: 未確認</div>
                <video id="camera" autoplay muted></video>

                <div class="button-group">
                    <button onclick="sendControlState(0)">Manual</button>
                    <button onclick="sendControlState(1)">Auto</button>
                </div>
            </div>
            <div class="camera-box">
                <div id="status">状態: 未確認</div>
                <video id="camera" autoplay muted></video>

                <div class="button-group">
                    <button onclick="sendControlState(0)">Manual</button>
                    <button onclick="sendControlState(1)">Auto</button>
                </div>
            </div>
            <div class="camera-box">
                <div id="status">状態: 未確認</div>
                <video id="camera" autoplay muted></video>

                <div class="button-group">
                    <button onclick="sendControlState(0)">Manual</button>
                    <button onclick="sendControlState(1)">Auto</button>
                </div>
            </div>
        </div>
    </div>



  <script>
    // カメラ表示処理
    const video = document.getElementById('camera');
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((stream) => {
        video.srcObject = stream;
      })
      .catch((err) => {
        console.error("カメラにアクセスできませんでした:", err);
      });

    // ROS連携処理
    const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });

    ros.on('connection', () => console.log("✅ Connected to rosbridge"));
    ros.on('error', (err) => console.error("❌ Error:", err));
    ros.on('close', () => console.log("🔌 Connection closed."));

    const isManualTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/orca_00/control_state',
      messageType: 'std_msgs/msg/Int32'
    });

    function sendControlState(value) {
      const msg = new ROSLIB.Message({ data: value });
      isManualTopic.publish(msg);
      console.log("📤 Sent is_manual:", value);
    }
    // is_enable service client
    const isEnableService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/enable',
      serviceType: 'std_srvs/srv/Empty'
    });

    // 状態を取得してUI更新
    function updateStatus() {
      const request = new ROSLIB.ServiceRequest({});
      isEnableService.callService(request, (result) => {
        // std_srvs/Empty はレスポンスデータを持たないため、何か出力したい場合は拡張が必要
        document.getElementById("status").innerText = "状態: enable（応答あり）";
      }, (error) => {
        document.getElementById("status").innerText = "状態: 無効 or 応答なし";
        console.warn("Service call failed:", error);
      });
    }

    setInterval(updateStatus, 10000);
  </script>
</body>
</html>
