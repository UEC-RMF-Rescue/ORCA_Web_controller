<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Robot Controller + Camera</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ORCAä¸¸å±±ãƒ­ãƒœãƒƒãƒˆ</h1>
  <div id="wrapper">
    <div id="controll-block">
      <h1>nanikahairu</h1>
      <h2>dezaintyouseisuru</h2>
    </div>
    <div id="camera-block">
      <h1>æ“ä½œãƒ–ãƒ­ãƒƒã‚¯</h1>
      <button onclick="callEnable()"> enable å‘¼ã³å‡ºã—</button>
      <button onclick="callDisable()"> disable å‘¼ã³å‡ºã—</button>
      <button onclick="callSetOffset()"> set_offset å‘¼ã³å‡ºã—</button>
      <div class="camera-box">
        <div id="status">çŠ¶æ…‹: æœªç¢ºèª</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button onclick="sendControlState(0)">Manual</button>
          <button onclick="sendControlState(1)">Auto</button>
        </div>
      </div>
      <!-- è¿½åŠ ã®ã‚«ãƒ¡ãƒ©ãƒœãƒƒã‚¯ã‚¹ã¯ã“ã“ã«åŒæ§˜ã«é…ç½® -->
    </div>
  </div>

  <script>
    const video = document.getElementById('camera');
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((stream) => { video.srcObject = stream; })
      .catch((err) => { console.error("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:", err); });

    const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });
    ros.on('connection', () => console.log("âœ… Connected to rosbridge"));
    ros.on('error', (err) => console.error("âŒ Error:", err));
    ros.on('close', () => console.log("ğŸ”Œ Connection closed."));

    const controlStateTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/orca_00/control_state',
      messageType: 'std_msgs/msg/Int32'
    });

    function sendControlState(value) {
      const msg = new ROSLIB.Message({ data: value });
      controlStateTopic.publish(msg);
      console.log("ğŸ“¤ Sent /orca_00/control_state:", value);
    }

    // ã‚µãƒ¼ãƒ“ã‚¹å®šç¾©
    const enableService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/enable',
      serviceType: 'std_srvs/srv/Empty'
    });

    const disableService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/disenable',
      serviceType: 'std_srvs/srv/Empty'
    });

    const setOffsetService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/set_offset',
      serviceType: 'std_srvs/srv/Empty'
    });

    // çŠ¶æ…‹è¡¨ç¤ºç”¨ãƒˆãƒ”ãƒƒã‚¯è³¼èª­ï¼ˆBoolå‹ï¼‰
    const enabledStateSub = new ROSLIB.Topic({
      ros: ros,
      name: '/orca_00/enabled_state',
      messageType: 'std_msgs/Bool'
    });

    enabledStateSub.subscribe((msg) => {
      const state = msg.data ? ' Enabled' : 'Disabled';
      document.getElementById("status").innerText = `çŠ¶æ…‹: ${state}`;
    });

    function callEnable() {
      const request = new ROSLIB.ServiceRequest({});
      enableService.callService(request,
        () => console.log("enable å‘¼ã³å‡ºã—æˆåŠŸ"),
        (error) => console.warn("enable å‘¼ã³å‡ºã—å¤±æ•—:", error)
      );
    }

    function callDisable() {
      const request = new ROSLIB.ServiceRequest({});
      disableService.callService(request,
        () => console.log("disable å‘¼ã³å‡ºã—æˆåŠŸ"),
        (error) => console.warn("disable å‘¼ã³å‡ºã—å¤±æ•—:", error)
      );
    }

    function callSetOffset() {
      const request = new ROSLIB.ServiceRequest({});
      setOffsetService.callService(request,
        () => console.log("set_offset å‘¼ã³å‡ºã—æˆåŠŸ"),
        (error) => console.warn("set_offset å‘¼ã³å‡ºã—å¤±æ•—:", error)
      );
    }
  </script>
</body>
</html>
