<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Robot Controller + Camera</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="wrapper">
    <div id="controll-block">
      <h1>nanikahairu</h1>
      <h2>dezaintyouseisuru</h2>
    </div>

    <div id="camera-block">
      <!--orca00-->
      <div class="camera-box">
        <!-- Enable / Disable ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹2ã¤ã®ãƒœã‚¿ãƒ³ -->
      <button id="enable-orca_00" onclick="callEnable('orca_00')" ></button>
      <button id="disable-orca_00" onclick="callDisable('orca_00')" style="display: none;"></button>
      <div class="is-enable auto" onclick="toggleMode(event, this, 'orca_00')">
        <div id="status-orca_00" style="display: none;">çŠ¶æ…‹: æœªç¢ºèª</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="callSetOffset('orca_00')">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
      <!--orca01-->
      <div class="camera-box">
        <!-- Enable / Disable ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹2ã¤ã®ãƒœã‚¿ãƒ³ -->
      <button id="enable-orca_01" onclick="callEnable('orca_01')" ></button>
      <button id="disable-orca_01" onclick="callDisable('orca_01')" style="display: none;"></button>
      <div class="is-enable auto" onclick="toggleMode(event, this, 'orca_01')">
        <div id="status-orca_01" style="display: none;">çŠ¶æ…‹: æœªç¢ºèª</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="event.stopPropagation(); callSetOffset('orca_01')">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
      <!--orca02-->
      <div class="camera-box">
        <!-- Enable / Disable ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹2ã¤ã®ãƒœã‚¿ãƒ³ -->
      <button id="enable-orca_02" onclick="callEnable('orca_02')" ></button>
      <button id="disable-orca_02" onclick="callDisable('orca_02')" style="display: none;"></button>
      <div class="is-enable auto" onclick="toggleMode(event, this, 'orca_02')">
        <div id="status-orca_02" style="display: none;">çŠ¶æ…‹: æœªç¢ºèª</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="callSetOffset('orca_02')">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
    </div>
    
  </div>

  <script>
    // ã‚«ãƒ¡ãƒ©ã®å–å¾—
    const video = document.getElementById('camera');
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((stream) => { video.srcObject = stream; })
      .catch((err) => { console.error("ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸ:", err); });

    // ROSãƒ–ãƒªãƒƒã‚¸ã«æ¥ç¶š
    const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });
    ros.on('connection', () => console.log("âœ… Connected to rosbridge"));
    ros.on('error', (err) => console.error("âŒ Error:", err));
    ros.on('close', () => console.log("ğŸ”Œ Connection closed."));

    // ãƒ­ãƒœãƒƒãƒˆåãƒªã‚¹ãƒˆï¼ˆæ–‡å­—åˆ—ã®é…åˆ—ã«ä¿®æ­£ï¼‰
    const robots = ['orca_00', 'orca_01', 'orca_02'];

    // å„ãƒ­ãƒœãƒƒãƒˆã”ã¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æ ¼ç´
    const robotInterfaces = {};

    robots.forEach(robotName => {
      robotInterfaces[robotName] = {
        controlStateTopic: new ROSLIB.Topic({
          ros,
          name: `/${robotName}/control_state`,
          messageType: 'std_msgs/msg/Int32'
        }),
        enableService: new ROSLIB.Service({
          ros,
          name: `/${robotName}/enable`,
          serviceType: 'std_srvs/srv/Empty'
        }),
        disableService: new ROSLIB.Service({
          ros,
          name: `/${robotName}/disable`,
          serviceType: 'std_srvs/srv/Empty'
        }),
        setOffsetService: new ROSLIB.Service({
          ros,
          name: `/${robotName}/set_offset`,
          serviceType: 'std_srvs/srv/Empty'
        }),
        enabledStateSub: new ROSLIB.Topic({
          ros,
          name: `/${robotName}/enabled_state`,
          messageType: 'std_msgs/Bool'
        })
      };

    // ãƒœã‚¿ãƒ³IDãŒ "enable-orca_00", "disable-orca_00" ã®ã‚ˆã†ã«ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹æƒ³å®š
    /*robotInterfaces[robotName].enabledStateSub.subscribe(msg => {
      const isEnabled = msg.data;
      document.getElementById(`status-${robotName}`).innerText = `çŠ¶æ…‹: ${isEnabled ? 'Enabled' : 'Disabled'}`;
      document.getElementById(`enable-${robotName}`).style.display = isEnabled ? "none" : "inline-block";
      document.getElementById(`disable-${robotName}`).style.display = isEnabled ? "inline-block" : "none";
      });*/
    });

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«é–¢æ•°ã‚’æ±ç”¨åŒ–
    function callEnable(robotName) {
      const req = new ROSLIB.ServiceRequest({});
      robotInterfaces[robotName].enableService.callService(req,
        () => {
          console.log(`${robotName} enable âœ…`);
          // æˆåŠŸã—ãŸã‚‰ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
          document.getElementById(`enable-${robotName}`).style.display = "none";
          document.getElementById(`disable-${robotName}`).style.display = "inline-block";
          document.getElementById(`status-${robotName}`).innerText = `çŠ¶æ…‹: Enabled`;
        },
        err => console.warn(`${robotName} enable âŒ`, err)
      );
    }

  function callDisable(robotName) {
    const req = new ROSLIB.ServiceRequest({});
      robotInterfaces[robotName].disableService.callService(req,
        () => {
          console.log(`${robotName} disable âœ…`);
          // æˆåŠŸã—ãŸã‚‰ãƒœã‚¿ãƒ³åˆ‡ã‚Šæ›¿ãˆ
          document.getElementById(`enable-${robotName}`).style.display = "inline-block";
          document.getElementById(`disable-${robotName}`).style.display = "none";
          document.getElementById(`status-${robotName}`).innerText = `çŠ¶æ…‹: Disabled`;
        },
        err => console.warn(`${robotName} disable âŒ`, err)
      );
    }

    function callSetOffset(robotName) {
      const req = new ROSLIB.ServiceRequest({});
      robotInterfaces[robotName].setOffsetService.callService(req,
        () => console.log(`${robotName} setOffset âœ…`),
        err => console.warn(`${robotName} setOffset âŒ`, err)
      );
    }

    function sendControlState(robotName, value) {
      const msg = new ROSLIB.Message({ data: value });
      robotInterfaces[robotName].controlStateTopic.publish(msg);
      console.log(`ğŸ“¤ ${robotName} control_state sent:`, value);
    }

    function toggleMode(event, div, robotName) {
      event.stopPropagation();
    }

    function callSetOffset(robotName) {
      const req = new ROSLIB.ServiceRequest({});
      robotInterfaces[robotName].setOffsetService.callService(req,
        () => console.log(`${robotName} setOffset âœ…`),
        err => console.warn(`${robotName} setOffset âŒ`, err)
      );
    }

    function sendControlState(robotName, value) {
      const msg = new ROSLIB.Message({ data: value });
      robotInterfaces[robotName].controlStateTopic.publish(msg);
      console.log(`ğŸ“¤ ${robotName} control_state sent:`, value);
    }

    function toggleMode(event, div, robotName) {
      event.stopPropagation();
      if (div.classList.contains("manual")) {
        div.classList.remove("manual");
        div.classList.add("auto");
        sendControlState(robotName, 1);
      } else {
        div.classList.remove("auto");
        div.classList.add("manual");
        sendControlState(robotName, 0);
      }
    }

    // Auto â†’ Manualã«åˆ‡ã‚Šæ›¿ãˆã‚‹
    function switchToManual() {
        currentControlState = 0;
        sendControlState(0);
        manualBtn.style.display = "inline-block";
        autoBtn.style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".camera-box button").forEach(btn => {
        btn.addEventListener("click", e => e.stopPropagation());
      });
    });
  </script>
</body>
</html>