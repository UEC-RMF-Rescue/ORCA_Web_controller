<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Robot Controller + Camera</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="wrapper">
    <div id="controll-block">
      <h1>nanikahairu</h1>
      <h2>dezaintyouseisuru</h2>
    </div>

    <div id="camera-block">
      <!--orca01-->
      <div class="camera-box">
        <!-- Enable / Disable を切り替える2つのボタン -->
      <button id="enable-button" onclick="callEnable()" >Enable</button>
      <button id="disable-button" onclick="callDisable()" style="display: none;">Disable</button>
      <div class="is-enable manual" onclick="toggleMode(this)">
        <div id="status" style="display: none;">状態: 未確認</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="callSetOffset()">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
      <!--orca02-->
      <div class="camera-box">
        <!-- Enable / Disable を切り替える2つのボタン -->
      <button id="enable-button" onclick="callEnable()" >Enable</button>
      <button id="disable-button" onclick="callDisable()" style="display: none;">Disable</button>
      <div class="is-enable manual" onclick="toggleMode(this)">
        <div id="status" style="display: none;">状態: 未確認</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="callSetOffset()">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
      <!--orca03-->
      <div class="camera-box">
        <!-- Enable / Disable を切り替える2つのボタン -->
      <button id="enable-button" onclick="callEnable()" >Enable</button>
      <button id="disable-button" onclick="callDisable()" style="display: none;">Disable</button>
      <div class="is-enable manual" onclick="toggleMode(this)">
        <div id="status" style="display: none;">状態: 未確認</div>
        <video id="camera" autoplay muted></video>
        <div class="button-group">
          <button>32do</button>
          <button onclick="callSetOffset()">offset</button>
          <button>arm</button>
        </div>
      </div>
      </div>
    </div>
    
  </div>

  <script>
    const video = document.getElementById('camera');
    navigator.mediaDevices.getUserMedia({ video: true, audio: false })
      .then((stream) => { video.srcObject = stream; })
      .catch((err) => { console.error("カメラにアクセスできませんでした:", err); });

    const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });
    ros.on('connection', () => console.log("✅ Connected to rosbridge"));
    ros.on('error', (err) => console.error("❌ Error:", err));
    ros.on('close', () => console.log("🔌 Connection closed."));

    const controlStateTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/orca_00/control_state',
      messageType: 'std_msgs/msg/Int32'
    });

    const enableService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/enable',
      serviceType: 'std_srvs/srv/Empty'
    });

    const disableService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/disenable',
      serviceType: 'std_srvs/srv/Empty'
    });

    const setOffsetService = new ROSLIB.Service({
      ros: ros,
      name: '/orca_00/set_offset',
      serviceType: 'std_srvs/srv/Empty'
    });

    const enabledStateSub = new ROSLIB.Topic({
      ros: ros,
      name: '/orca_00/enabled_state',
      messageType: 'std_msgs/Bool'
    });

    // 状態に応じてボタンの表示を切り替える
    enabledStateSub.subscribe((msg) => {
      const isEnabled = msg.data;
      document.getElementById("status").innerText = `状態: ${isEnabled ? 'Enabled' : 'Disabled'}`;

      document.getElementById("enable-button").style.display = isEnabled ? "none" : "inline-block";
      document.getElementById("disable-button").style.display = isEnabled ? "inline-block" : "none";
    });

    function callEnable() {
        const request = new ROSLIB.ServiceRequest({});
        enableService.callService(request,
          () => console.log("✅ enable 呼び出し成功"),
          (error) => console.warn("❌ enable 呼び出し失敗:", error)
        );
    }

    function callDisable() {
        const request = new ROSLIB.ServiceRequest({});
        disableService.callService(request,
          () => console.log("✅ disable 呼び出し成功"),
          (error) => console.warn("❌ disable 呼び出し失敗:", error)
        );
    }

    function callSetOffset() {
      const request = new ROSLIB.ServiceRequest({});
      setOffsetService.callService(request,
        () => console.log("✅ set_offset 呼び出し成功"),
        (error) => console.warn("❌ set_offset 呼び出し失敗:", error)
      );
    }

    let currentControlState = 0; // 初期状態は Manual

    const manualBtn = document.getElementById("manual-bg-button");
    const autoBtn = document.getElementById("auto-bg-button");

    function sendControlState(value) {
      const msg = new ROSLIB.Message({ data: value });
      controlStateTopic.publish(msg);
      console.log("📤 Sent /orca_00/control_state:", value);
    }

    // Manual → Autoに切り替える
    function switchToAuto() {
        currentControlState = 1;
        sendControlState(1);
        manualBtn.style.display = "none";
        autoBtn.style.display = "inline-block";
    }

    // Auto → Manualに切り替える
    function switchToManual() {
        currentControlState = 0;
        sendControlState(0);
        manualBtn.style.display = "inline-block";
        autoBtn.style.display = "none";
    }

    function toggleMode(div) {
    if (div.classList.contains("manual")) {
      div.classList.remove("manual");
      div.classList.add("auto");
      sendControlState(1);  // 状態送信
    } else {
      div.classList.remove("auto");
      div.classList.add("manual");
      sendControlState(0);
    }
}

  </script>
</body>
</html>
